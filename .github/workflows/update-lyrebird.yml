name: Update Dockerfile ARG LYREBIRD_VERSION

on:
  workflow_dispatch:
  schedule:
    - cron: '48 7,17 * * *' # Twice a day

jobs:
  update-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Fetch latest GitLab tag (lyrebird)
        id: gitlab_tag
        run: |
          GITLAB_PROJECT="tpo%2Fanti-censorship%2Fpluggable-transports%2Flyrebird"  # URL‑encoded namespace/project
          GITLAB_API="https://gitlab.torproject.org/api/v4/projects/${GITLAB_PROJECT}/repository/tags"

          # Get the newest tag name
          raw_tag=$(curl -sSf "$GITLAB_API" | jq -r '.[0].name')

          # Remove a leading "lyrebird-" if present
          clean_tag=${raw_tag#lyrebird-}

          echo "raw_tag=$raw_tag" >> $GITHUB_OUTPUT
          echo "clean_tag=$clean_tag" >> $GITHUB_OUTPUT

      - name: Read current Dockerfile LYREBIRD_VERSION
        id: docker_tag
        run: |
          current_tag=$(grep -E '^ARG\s+LYREBIRD_VERSION=' Dockerfile \
                         | head -n1 \
                         | cut -d'=' -f2 \
                         | tr -d '"' | tr -d "'")
          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT

      - name: Update Dockerfile if needed
        id: update
        env:
          LATEST_TAG: ${{ steps.gitlab_tag.outputs.clean_tag }}
          CURRENT_TAG: ${{ steps.docker_tag.outputs.current_tag }}
        run: |
          if [ -z "$LATEST_TAG" ] || [ -z "$CURRENT_TAG" ]; then
            echo "Missing tag information – aborting."
            exit 1
          fi

          echo "Latest (clean) tag: $LATEST_TAG"
          echo "Current Dockerfile tag: $CURRENT_TAG"

          if [ "$LATEST_TAG" = "$CURRENT_TAG" ]; then
            echo "Tag already up‑to‑date."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Replace the ARG line (assumes a single version ARG)
          sed -i -E "s/^(ARG\s+LYREBIRD_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile
          sed -i -E "s/^(ARG\s+LYREBIRD_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile.lyrebird
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Check for existing open PR
        id: pr_check
        uses: actions/github-script@v8
        with:
          script: |
            const { data: prs } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              head: `${context.repo.owner}:update-lyrebird-tag`
            })
            core.setOutput('pr_exists', prs.length > 0 ? 'true' : 'false')
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create branch, commit & push
        if: steps.update.outputs.changed == 'true' && steps.pr_check.outputs.pr_exists == 'false'
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: 41898282+github-actions[bot]@users.noreply.github.com
        run: |
          BRANCH="update-lyrebird-tag"
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          # Delete local branch if it already exists (e.g. from a previous run)
          git branch -D "$BRANCH" || true
          git checkout -b "$BRANCH"
          git add Dockerfile Dockerfile.quick
          git commit -m "Update Dockerfile ARG LYREBIRD_VERSION to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          # Force-push so an existing open PR is automatically updated
          git push origin "$BRANCH" --force

      - name: Create Pull Request
        id: cpr
        if: steps.update.outputs.changed == 'true' && steps.pr_check.outputs.pr_exists == 'false'
        uses: peter-evans/create-pull-request@v8
        with:
          branch: update-lyrebird-tag
          base: master
          title: "Update Dockerfile ARG LYREBIRD_VERSION to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          body: |
            This PR updates the `ARG LYREBIRD_VERSION` line in `Dockerfile` to the latest tag from the GitLab repository, with the `lyrebird-` prefix removed.

            - **Previous tag:** ${{ steps.docker_tag.outputs.current_tag }}
            - **New tag:** ${{ steps.gitlab_tag.outputs.clean_tag }}
          commit-message: "Update Dockerfile ARG LYREBIRD_VERSION to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          labels: dependencies
          delete-branch: true

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
