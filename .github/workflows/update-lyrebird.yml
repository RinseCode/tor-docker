name: Update Dockerfile ARG LYREBIRD_VERSION

on:
  workflow_dispatch:
  schedule:
    - cron: '48 7,17 * * *' # Twice a day

jobs:
  update-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Fetch latest GitLab tag (lyrebird)
        id: gitlab_tag
        run: |
          GITLAB_PROJECT="tpo%2Fanti-censorship%2Fpluggable-transports%2Flyrebird"  # URL-encoded namespace/project
          GITLAB_API="https://gitlab.torproject.org/api/v4/projects/${GITLAB_PROJECT}/repository/tags"

          # Retrieve **all** tags (newest first)
          tags=$(curl -sSf "$GITLAB_API" | jq -r '.[].name')

          # Find the first tag that is not a pre-release
          for raw_tag in $tags; do
            # Strip optional leading “lyrebird-”
            clean_tag=${raw_tag#lyrebird-}

            # Skip tags that contain “-rc” or “-alpha”
            if [[ "$clean_tag" == *-rc* || "$clean_tag" == *-alpha* ]]; then
              continue
            fi

            # This is the newest stable tag - stop looping
            # Export for later steps
            echo "raw_tag=$raw_tag"   >> $GITHUB_OUTPUT
            echo "clean_tag=$clean_tag" >> $GITHUB_OUTPUT
            break
          done

      - name: Update Dockerfile if needed
        id: update
        env:
          LATEST_TAG: ${{ steps.gitlab_tag.outputs.clean_tag }}
          CURRENT_TAG: ${{ steps.docker_tag.outputs.current_tag }}
        run: |
          if [ -z "$LATEST_TAG" ] || [ -z "$CURRENT_TAG" ]; then
            echo "Missing tag information – aborting."
            exit 1
          fi

          echo "Latest (clean) tag: $LATEST_TAG"
          echo "Current Dockerfile tag: $CURRENT_TAG"

          if [ "$LATEST_TAG" = "$CURRENT_TAG" ]; then
            echo "Tag already up‑to‑date."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Replace the ARG line (assumes a single version ARG)
          sed -i -E "s/^(ARG\s+LYREBIRD_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile
          sed -i -E "s/^(ARG\s+LYREBIRD_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile.lyrebird
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create Pull Request
        id: cpr
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          branch: update-lyrebird-tag
          base: master
          title: "Update Dockerfile ARG LYREBIRD_VERSION to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          body: |
            This PR updates the `ARG LYREBIRD_VERSION` line in `Dockerfile` to the latest tag from the GitLab repository, with the `lyrebird-` prefix removed.

            - **Previous tag:** ${{ steps.docker_tag.outputs.current_tag }}
            - **New tag:** ${{ steps.gitlab_tag.outputs.clean_tag }}
          commit-message: "Update Dockerfile ARG LYREBIRD_VERSION to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          labels: dependencies
          delete-branch: true

      - name: Enable Pull Request Automerge
        if: steps.cpr.outputs.pull-request-operation == 'created'
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
