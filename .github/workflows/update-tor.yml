name: Update Dockerfile ARG TOR_VERSION

on:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'   # daily at 02:00 UTC

jobs:
  update-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Install utilities
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl git

      - name: Fetch latest GitLab tag
        id: gitlab_tag
        run: |
          GITLAB_PROJECT="tpo%2Fcore%2Ftor"   # URL‑encoded namespace/project
          GITLAB_API="https://gitlab.torproject.org/api/v4/projects/${GITLAB_PROJECT}/repository/tags"

          # Grab the newest tag name
          raw_tag=$(curl -sSf  "$GITLAB_API" \
                     | jq -r '.[0].name')

          # Remove a leading "tor-" if present
          clean_tag=${raw_tag#tor-}

          echo "raw_tag=$raw_tag" >> $GITHUB_OUTPUT
          echo "clean_tag=$clean_tag" >> $GITHUB_OUTPUT

      - name: Read current Dockerfile TOR_VERSION
        id: docker_tag
        run: |
          DOCKERFILE="Dockerfile"

          # Extract the value after the = (strip possible quotes)
          current_tag=$(grep -E '^ARG\s+TOR_VERSION=' "$DOCKERFILE" \
                         | head -n1 \
                         | cut -d'=' -f2 \
                         | tr -d '"' \
                         | tr -d "'")
          echo "current_tag=$current_tag" >> $GITHUB_OUTPUT

      - name: Update Dockerfile if needed
        id: update
        env:
          LATEST_TAG: ${{ steps.gitlab_tag.outputs.clean_tag }}
          CURRENT_TAG: ${{ steps.docker_tag.outputs.current_tag }}
        run: |
          if [ -z "$LATEST_TAG" ] || [ -z "$CURRENT_TAG" ]; then
            echo "Missing tag information – aborting."
            exit 1
          fi

          echo "Latest (clean) tag: $LATEST_TAG"
          echo "Current Dockerfile tag: $CURRENT_TAG"

          if [ "$LATEST_TAG" = "$CURRENT_TAG" ]; then
            echo "Tag already up‑to‑date."
            echo "changed=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          # Replace the ARG line (assumes a single version ARG)
          sed -i -E "s/^(ARG\s+TOR_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile
          sed -i -E "s/^(ARG\s+TOR_VERSION)=.*/\1=$LATEST_TAG/" Dockerfile.quick
          echo "changed=true" >> $GITHUB_OUTPUT

      - name: Create branch, commit & push
        if: steps.update.outputs.changed == 'true'
        env:
          GIT_AUTHOR_NAME: github-actions[bot]
          GIT_AUTHOR_EMAIL: github-actions[bot]@users.noreply.github.com
        run: |
          BRANCH="update-tag-$(date +%s)"
          git config user.name "$GIT_AUTHOR_NAME"
          git config user.email "$GIT_AUTHOR_EMAIL"
          git checkout -b "$BRANCH"
          git add Dockerfile
          git add Dockerfile.quick
          git commit -m "Update Dockerfile ARG TOR_VERSION tag to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          git push origin "$BRANCH"

      - name: Create Pull Request
        if: steps.update.outputs.changed == 'true'
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: "update-tag-${{ steps.update.outputs.branch || ''}}"
          base: master
          title: "Update Dockerfile ARG tag to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          body: |
            This PR updates the `ARG TOR_VERSION` line in `Dockerfile` to the latest tag from the GitLab repository, with the `tor-` prefix removed.

            - **Previous tag:** ${{ steps.docker_tag.outputs.current_tag }}
            - **New tag:** ${{ steps.gitlab_tag.outputs.clean_tag }}

          commit-message: "Update Dockerfile ARG TOR_VERSION tag to ${{ steps.gitlab_tag.outputs.clean_tag }}"
          delete-branch: true
